##
## Scanarr — Stack Portainer pour Synology DS923+
## Serveur : 192.168.1.91
##
## ETAPE 1 — Rendre les images publiques sur GitHub (une seule fois) :
##   https://github.com/users/voclinx/packages/container/scannarr-api/settings
##   https://github.com/users/voclinx/packages/container/scannarr-front/settings
##   → "Change package visibility" → Public
##
## ETAPE 2 — Dans Portainer :
##   Stacks > Add stack > Upload (ce fichier)
##   Descendre jusqu'à "Environment variables" et ajouter :
##     DB_PASSWORD        Wxy2GkbzM5wkWipSWNJtv8I69X8yBAtj
##     APP_SECRET         d9ffa95ab98749cab44a42499c29532a8588d837b7d79c7dcdbc7f799efefbaf
##     JWT_PASSPHRASE     QzJmvdXl0rWcdChRDPsjjfCHsko
##     WATCHER_AUTH_TOKEN ed5dfd5706f60dc60f26b8d46da005b6c96486417daef2523a5daaf812a221a3
##
## ETAPE 3 — Cliquer "Deploy the stack"
##
## Watcher : binaire natif à installer séparément sur le NAS
##   Voir : docs/DEPLOYMENT_SYNOLOGY.md
##

services:

  ##
  ## Base de données PostgreSQL
  ## Données persistées dans /volume1/docker/scannar/postgres
  ##
  db:
    image: postgres:16-alpine
    container_name: scanarr-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: scanarr
      POSTGRES_USER: scanarr
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - /volume1/docker/scannar/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scanarr"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - scanarr-net

  ##
  ## API Symfony + WebSocket
  ## Port 8081 exposé pour le watcher natif sur le NAS
  ##
  api:
    image: ghcr.io/voclinx/scannarr-api:latest
    container_name: scanarr-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://scanarr:${DB_PASSWORD}@db:5432/scanarr?serverVersion=16&charset=utf8
      APP_ENV: prod
      APP_SECRET: ${APP_SECRET}
      JWT_PASSPHRASE: ${JWT_PASSPHRASE}
      JWT_TOKEN_TTL: 3600
      WATCHER_AUTH_TOKEN: ${WATCHER_AUTH_TOKEN}
      CORS_ALLOW_ORIGIN: '^https?://192\.168\.1\.91(:[0-9]+)?$'
      DEFAULT_URI: http://192.168.1.91:8585
    volumes:
      - /volume1/filmarr:/mnt/filmarr:ro
    ports:
      - "8081:8081"
    networks:
      - scanarr-net

  ##
  ## Frontend Vue.js (Nginx)
  ## Point d'entrée unique : http://192.168.1.91:8585
  ## Le nginx interne proxifie /api/ → api:8080 et /ws/ → api:8081
  ##
  front:
    image: ghcr.io/voclinx/scannarr-front:latest
    container_name: scanarr-front
    restart: unless-stopped
    depends_on:
      - api
    ports:
      - "8585:80"
    networks:
      - scanarr-net

networks:
  scanarr-net:
    driver: bridge
